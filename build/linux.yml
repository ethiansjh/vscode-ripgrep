steps:
- script: |
    sudo apt-get update
    sudo apt-get install -y musl-tools
  displayName: Install dependencies
- template: install_rust.yml
  parameters:
    rustup_toolchain: nightly
- template: clone_ripgrep.yml
- script: |
    export PCRE2_SYS_STATIC=1
    cd ripgrep
    rustup target add x86_64-unknown-linux-musl
    cargo build --release --target=x86_64-unknown-linux-musl --features 'pcre2'
    strip ./target/x86_64-unknown-linux-musl/release/rg
    zip -j "ripgrep-linux-x64.zip" ./target/x86_64-unknown-linux-musl/release/rg
  displayName: Build
- task: GitHubRelease@0
  inputs:
    gitHubConnection: GitHub
    repositoryName: '$(Build.Repository.Name)'
    action: 'create'
    target: '$(Build.SourceVersion)'
    tagSource: 'auto'
    assets: '$(Build.ArtifactStagingDirectory)/*'
    isDraft: true
